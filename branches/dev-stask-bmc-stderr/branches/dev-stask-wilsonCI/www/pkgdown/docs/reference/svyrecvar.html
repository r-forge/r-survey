<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Variance estimation for multistage surveys — svyrecvar • survey</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Variance estimation for multistage surveys — svyrecvar"><meta property="og:description" content="Compute the variance of a total under multistage sampling, using a
  recursive descent algorithm."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">survey</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">4.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Variance estimation for multistage surveys</h1>
    
    <div class="hidden name"><code>svyrecvar.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Compute the variance of a total under multistage sampling, using a
  recursive descent algorithm.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">svyrecvar</span><span class="op">(</span><span class="va">x</span>, <span class="va">clusters</span>, <span class="va">stratas</span>,<span class="va">fpcs</span>, postStrata <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>lonely.psu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"survey.lonely.psu"</span><span class="op">)</span>,</span>
<span>one.stage<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"survey.ultimate.cluster"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>x</dt>
<dd><p>Matrix of data or estimating functions</p></dd>

  <dt>clusters</dt>
<dd><p>Data frame or matrix with cluster ids for each stage</p></dd>

  <dt>stratas</dt>
<dd><p>Strata for each stage</p></dd>

  <dt>fpcs</dt>
<dd><p>Information on population and sample size for each stage,
    created by <code><a href="as.fpc.html">as.fpc</a></code></p></dd>

  <dt>postStrata</dt>
<dd><p>post-stratification information as created by
    <code><a href="postStratify.html">postStratify</a></code> or <code><a href="calibrate.html">calibrate</a></code></p></dd>

  <dt>lonely.psu</dt>
<dd><p>How to handle strata with a single PSU</p></dd>

  <dt>one.stage</dt>
<dd><p>If <code>TRUE</code>, compute a one-stage
    (ultimate-cluster) estimator</p></dd>

</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>The main use of this function is to compute the variance of the sum
  of a set of estimating functions under multistage sampling.  The
  sampling is assumed to be simple or stratified random sampling within
  clusters at each stage except perhaps the last stage.  The variance of
  a statistic is computed from the variance of estimating functions as
  described by Binder (1983).</p>  
<p>Use <code>one.stage=FALSE</code> for compatibility with other software that
  does not perform multi-stage calculations, and set
  <code>options(survey.ultimate.cluster=TRUE)</code> to make this the default.</p>  
<p>The idea of a recursive algorithm is due to Bellhouse (1985).
  Texts such as Cochran (1977) and Sarndal et al (1991) describe the
  decomposition of the variance into a single-stage between-cluster
  estimator and a within-cluster estimator, and this is applied recursively.</p>  
<p>If <code>one.stage</code> is a positive integer it specifies the number of
  stages of sampling to use in the recursive estimator.</p>
<p>If <code>pps="brewer"</code>, standard errors are estimated using Brewer's
  approximation for PPS without replacement, option 2 of those described
  by Berger (2004). The <code>fpc</code> argument must then be specified in
  terms of sampling fractions, not population sizes (or omitted, but
  then the <code>pps</code> argument would have no effect and the
  with-replacement standard errors would be correct).</p>
    </div>
    <div id="value">
    <h2>Value</h2>
    

<p>A covariance matrix</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Bellhouse DR (1985) Computing Methods for Variance Estimation in Complex Surveys.
  Journal of Official Statistics. Vol.1, No.3, 1985</p>
<p>Berger, Y.G. (2004), A Simple Variance Estimator for Unequal
  Probability Sampling Without Replacement. Journal of Applied
  Statistics, 31, 305-315.</p>  
<p>Binder, David A. (1983).  On the variances of asymptotically normal
  estimators from complex surveys.  International Statistical Review,
  51, 279-292.</p>
<p>Brewer KRW (2002) Combined Survey Sampling Inference (Weighing Basu's
  Elephants)  [Chapter 9]</p>
<p>Cochran, W. (1977)  Sampling Techniques. 3rd edition. Wiley.</p>  
<p>Sarndal C-E, Swensson B, Wretman J (1991) Model Assisted Survey
  Sampling. Springer.</p>
    </div>
    <div id="note">
    <h2>Note</h2>
    <p>A simple set of finite population corrections will only be exactly
  correct when each successive stage uses simple or stratified random
  sampling without replacement.  A correction under general unequal
  probability sampling (eg PPS) would require joint inclusion probabilities (or,
  at least, sampling probabilities for units not included in the sample),
  information not generally available.</p>
<p>The quality of Brewer's approximation is excellent in Berger's
  simulations, but the accuracy may vary depending on the sampling
  algorithm used.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="svrVar.html">svrVar</a></code> for replicate weight designs</p>    
<p><code><a href="svyCprod.html">svyCprod</a></code> for a description of how variances are
    estimated at each stage</p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mu284</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dmu284</span><span class="op">&lt;-</span><span class="fu"><a href="svydesign.html">svydesign</a></span><span class="op">(</span>id<span class="op">=</span><span class="op">~</span><span class="va">id1</span><span class="op">+</span><span class="va">id2</span>,fpc<span class="op">=</span><span class="op">~</span><span class="va">n1</span><span class="op">+</span><span class="va">n2</span>, data<span class="op">=</span><span class="va">mu284</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">y1</span>, <span class="va">dmu284</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> y1 15080 2274.3</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">api</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># two-stage cluster sample</span></span></span>
<span class="r-in"><span><span class="va">dclus2</span><span class="op">&lt;-</span><span class="fu"><a href="svydesign.html">svydesign</a></span><span class="op">(</span>id<span class="op">=</span><span class="op">~</span><span class="va">dnum</span><span class="op">+</span><span class="va">snum</span>, fpc<span class="op">=</span><span class="op">~</span><span class="va">fpc1</span><span class="op">+</span><span class="va">fpc2</span>, data<span class="op">=</span><span class="va">apiclus2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dclus2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 - level Cluster Sampling design</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> With (40, 126) clusters.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> svydesign(id = ~dnum + snum, fpc = ~fpc1 + fpc2, data = apiclus2)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Probabilities:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.003669 0.037743 0.052840 0.042390 0.052840 0.052840 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Population size (PSUs): 757 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Data variables:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [1] "cds"      "stype"    "name"     "sname"    "snum"     "dname"   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [7] "dnum"     "cname"    "cnum"     "flag"     "pcttest"  "api00"   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [13] "api99"    "target"   "growth"   "sch.wide" "comp.imp" "both"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [19] "awards"   "meals"    "ell"      "yr.rnd"   "mobility" "acs.k3"  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [25] "acs.46"   "acs.core" "pct.resp" "not.hsg"  "hsg"      "some.col"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [31] "col.grad" "grad.sch" "avg.ed"   "full"     "emer"     "enroll"  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [37] "api.stu"  "pw"       "fpc1"     "fpc2"    </span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span>, <span class="va">dclus2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         mean     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00 670.81 30.099</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">enroll</span>, <span class="va">dclus2</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 2639273 799638</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># bootstrap for multistage sample</span></span></span>
<span class="r-in"><span><span class="va">mrbclus2</span><span class="op">&lt;-</span><span class="fu"><a href="as.svrepdesign.html">as.svrepdesign</a></span><span class="op">(</span><span class="va">dclus2</span>, type<span class="op">=</span><span class="st">"mrb"</span>, replicates<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">enroll</span>, <span class="va">mrbclus2</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 2639273 857469</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># two-stage `with replacement'</span></span></span>
<span class="r-in"><span><span class="va">dclus2wr</span><span class="op">&lt;-</span><span class="fu"><a href="svydesign.html">svydesign</a></span><span class="op">(</span>id<span class="op">=</span><span class="op">~</span><span class="va">dnum</span><span class="op">+</span><span class="va">snum</span>, weights<span class="op">=</span><span class="op">~</span><span class="va">pw</span>, data<span class="op">=</span><span class="va">apiclus2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dclus2wr</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 - level Cluster Sampling design (with replacement)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> With (40, 126) clusters.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> svydesign(id = ~dnum + snum, weights = ~pw, data = apiclus2)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Probabilities:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.003669 0.037743 0.052840 0.042390 0.052840 0.052840 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Data variables:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [1] "cds"      "stype"    "name"     "sname"    "snum"     "dname"   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [7] "dnum"     "cname"    "cnum"     "flag"     "pcttest"  "api00"   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [13] "api99"    "target"   "growth"   "sch.wide" "comp.imp" "both"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [19] "awards"   "meals"    "ell"      "yr.rnd"   "mobility" "acs.k3"  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [25] "acs.46"   "acs.core" "pct.resp" "not.hsg"  "hsg"      "some.col"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [31] "col.grad" "grad.sch" "avg.ed"   "full"     "emer"     "enroll"  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [37] "api.stu"  "pw"       "fpc1"     "fpc2"    </span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span>, <span class="va">dclus2wr</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         mean     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00 670.81 30.712</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">enroll</span>, <span class="va">dclus2wr</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 2639273 820261</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by “Thomas Lumley”.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

