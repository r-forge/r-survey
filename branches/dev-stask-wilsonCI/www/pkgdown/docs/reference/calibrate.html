<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Calibration (GREG) estimators — calibrate • survey</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Calibration (GREG) estimators — calibrate"><meta property="og:description" content="Calibration, generalized raking, or GREG estimators generalise post-stratification and
  raking by calibrating a sample to the marginal totals of
  variables in a linear regression model.  This function reweights the
  survey design and adds additional information that is used by
  svyrecvar to reduce the estimated standard errors."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">survey</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">4.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Calibration (GREG) estimators</h1>
    
    <div class="hidden name"><code>calibrate.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Calibration, generalized raking, or GREG estimators generalise post-stratification and
  raking by calibrating a sample to the marginal totals of
  variables in a linear regression model.  This function reweights the
  survey design and adds additional information that is used by
  <code>svyrecvar</code> to reduce the estimated standard errors.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">calibrate</span><span class="op">(</span><span class="va">design</span>,<span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># S3 method for survey.design2</span></span>
<span><span class="fu">calibrate</span><span class="op">(</span><span class="va">design</span>, <span class="va">formula</span>, <span class="va">population</span>,</span>
<span>       aggregate.stage<span class="op">=</span><span class="cn">NULL</span>, stage<span class="op">=</span><span class="fl">0</span>, variance<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>       bounds<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>,<span class="cn">Inf</span><span class="op">)</span>, calfun<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"linear"</span>,<span class="st">"raking"</span>,<span class="st">"logit"</span><span class="op">)</span>,</span>
<span>       maxit<span class="op">=</span><span class="fl">50</span>,epsilon<span class="op">=</span><span class="fl">1e-7</span>,verbose<span class="op">=</span><span class="cn">FALSE</span>,force<span class="op">=</span><span class="cn">FALSE</span>,trim<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>       bounds.const<span class="op">=</span><span class="cn">FALSE</span>, sparse<span class="op">=</span><span class="cn">FALSE</span>,<span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># S3 method for svyrep.design</span></span>
<span><span class="fu">calibrate</span><span class="op">(</span><span class="va">design</span>, <span class="va">formula</span>, <span class="va">population</span>,compress<span class="op">=</span><span class="cn">NA</span>,</span>
<span>       aggregate.index<span class="op">=</span><span class="cn">NULL</span>, variance<span class="op">=</span><span class="cn">NULL</span>, bounds<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>,<span class="cn">Inf</span><span class="op">)</span>,</span>
<span>       calfun<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"linear"</span>,<span class="st">"raking"</span>,<span class="st">"logit"</span><span class="op">)</span>,</span>
<span>       maxit<span class="op">=</span><span class="fl">50</span>, epsilon<span class="op">=</span><span class="fl">1e-7</span>, verbose<span class="op">=</span><span class="cn">FALSE</span>,force<span class="op">=</span><span class="cn">FALSE</span>,trim<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>       bounds.const<span class="op">=</span><span class="cn">FALSE</span>, sparse<span class="op">=</span><span class="cn">FALSE</span>,<span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># S3 method for twophase</span></span>
<span><span class="fu">calibrate</span><span class="op">(</span><span class="va">design</span>, phase<span class="op">=</span><span class="fl">2</span>,<span class="va">formula</span>, <span class="va">population</span>,</span>
<span>       calfun<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"linear"</span>,<span class="st">"raking"</span>,<span class="st">"logit"</span>,<span class="st">"rrz"</span><span class="op">)</span>,<span class="va">...</span><span class="op">)</span></span>
<span><span class="fu">grake</span><span class="op">(</span><span class="va">mm</span>,<span class="va">ww</span>,<span class="va">calfun</span>,eta<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span><span class="op">)</span>,<span class="va">bounds</span>,<span class="va">population</span>,<span class="va">epsilon</span>, </span>
<span>  <span class="va">verbose</span>,<span class="va">maxit</span>,variance<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="fu">cal_names</span><span class="op">(</span><span class="va">formula</span>,<span class="va">design</span>,<span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>design</dt>
<dd><p>Survey design object</p></dd>

  <dt>formula</dt>
<dd><p>Model formula for calibration model, or list of
    formulas for each margin</p></dd>

  <dt>population</dt>
<dd><p>Vectors of population column totals for the model matrix in the
    calibration model, or list of such vectors for each
    cluster, or list of tables for each margin. Required except for two-phase designs</p></dd>

  <dt>compress</dt>
<dd><p>compress the resulting replicate weights if
    <code>TRUE</code> or if <code>NA</code> and weights were previously compressed</p></dd>

  <dt>stage</dt>
<dd><p>See Details below</p></dd>

  <dt>variance</dt>
<dd><p>Coefficients for variance in calibration model (heteroskedasticity parameters) (see
    Details below)</p></dd>

  <dt>aggregate.stage</dt>
<dd><p>An integer. If not <code>NULL</code>, make calibration weights
    constant within sampling units at this stage.</p></dd>

  <dt>aggregate.index</dt>
<dd><p>A vector or one-sided formula. If not <code>NULL</code>, make calibration weights
    constant within levels of this variable</p></dd>

  <dt>bounds</dt>
<dd><p>Bounds for the calibration weights, optional
    except for <code>calfun="logit"</code></p></dd>

  <dt>bounds.const</dt>
<dd><p>Should be <code>TRUE</code> if <code>bounds</code> have been spcified as constant values rather than multiplicative values</p></dd>

  <dt>trim</dt>
<dd><p>Weights outside this range will be trimmed to these bounds.</p></dd>

  <dt>...</dt>
<dd><p>Options for other methods</p></dd>

  <dt>calfun</dt>
<dd><p>Calibration function: see below</p></dd>

  <dt>maxit</dt>
<dd><p>Number of iterations</p></dd>

  <dt>epsilon</dt>
<dd><p>Tolerance in matching population total. Either a single
  number or a vector of the same length as <code>population</code></p></dd>

  <dt>verbose</dt>
<dd><p>Print lots of uninteresting information</p></dd>

  <dt>force</dt>
<dd><p>Return an answer even if the specified accuracy was not achieved</p></dd>

  <dt>phase</dt>
<dd><p>Phase of a two-phase design to calibrate (only
    <code>phase=2</code> currently implemented.)</p></dd>

  <dt>mm</dt>
<dd><p>Model matrix</p></dd>

  <dt>ww</dt>
<dd><p>Vector of weights</p></dd>

  <dt>eta</dt>
<dd><p>Starting values for iteration</p></dd>

  <dt>sparse</dt>
<dd><p>Use sparse matrices for faster computation</p></dd>

</dl></div>
    <div id="details">
    <h2>Details</h2>
    

<p>The <code>formula</code> argument specifies a model matrix, and the
  <code>population</code> argument is the population column sums of this
  matrix. The function <code>cal_names</code> shows what the column names of
  this model matrix will be.</p>
<p>For the important special case where the calibration totals are (possibly
  overlapping) marginal tables of factor variables, as in classical
  raking, the <code>formula</code> and <code>population</code> arguments may be
  lists in the same format as the input to <code><a href="rake.html">rake</a></code>.</p>
<p>If the <code>population</code> argument has a names attribute it will be
  checked against the names produced by <code>model.matrix(formula)</code> and
  reordered if necessary.  This protects against situations where the
  (locale-dependent) ordering of factor levels is not what you expected.</p>
<p>Numerical instabilities may result if the sampling weights in the
  <code>design</code> object are wrong by multiple orders of magnitude. The
  code now attempts to rescale the weights first, but it is better for
  the user to ensure that the scale is reasonable.</p>  
<p>The <code>calibrate</code> function implements linear, bounded linear,
  raking, bounded raking, and logit calibration functions. All except
  unbounded linear calibration use the Newton-Raphson algorithm
  described by Deville et al (1993). This algorithm is exposed for other
  uses in the <code>grake</code> function.  Unbounded linear calibration uses
  an algorithm that is less sensitive to collinearity. The calibration
  function may be specified as a string naming one of the three built-in
  functions or as an object of class <code>calfun</code>, allowing
  user-defined functions. See <code><a href="make.calfun.html">make.calfun</a></code> for details.</p>
<p>The <code>bounds</code> argument can be specified as global upper and lower bounds e.g
  <code>bounds=c(0.5, 2)</code> or as a list with lower and upper vectors e.g. 
  <code>bounds=list(lower=lower, upper=upper)</code>. This allows for individual 
  boundary constraints for each unit. The lower and upper vectors must be 
  the same length as the input data. The bounds can be specified as multiplicative 
  values or constant values. If constant, <code>bounds.const</code> must be set to <code>TRUE</code>.</p>
<p>Calibration with bounds, or on highly collinear data, may fail. If
  <code>force=TRUE</code> the approximately calibrated design object will
  still be returned (useful for examining why it failed). A failure in
  calibrating a set of replicate weights when the sampling weights were
  successfully calibrated will give only a warning, not an error.</p>  
<p>When calibration to the desired set of bounds is not possible, another option is
  to trim weights. To do this set <code>bounds</code> to a looser set of bounds
  for which calibration is achievable and set <code>trim</code> to the tighter
  bounds. Weights outside the bounds will be trimmed to the bounds, and
  the excess weight distributed over other observations in proportion to
  their sampling weight (and so this may put some other observations
  slightly over the trimming bounds). The projection matrix used in computing
  standard errors is based on the feasible bounds specified by the
  <code>bounds</code> argument.  See also <code><a href="trimWeights.html">trimWeights</a></code>,
  which trims the final weights in a design object rather than the
  calibration adjustments.</p>
  
<p>For two-phase designs <code>calfun="rrz"</code> estimates the sampling
  probabilities using logistic regression as described by Robins et al
  (1994). <code><a href="estweights.html">estWeights</a></code> will do the same thing.</p>
<p>Calibration may result in observations within the last-stage sampling
  units having unequal weight even though they necessarily are sampled
  together.  Specifying <code>aggegrate.stage</code> ensures that the
  calibration weight adjustments are constant within sampling units at
  the specified stage; if the original sampling weights were equal the
  final weights will also be equal.  The algorithm is as described by
  Vanderhoeft (2001, section III.D). Specifying <code>aggregate.index</code>
  does the same thing for replicate weight designs; a warning will be
  given if the original weights are not constant within levels of
  <code>aggregate.index</code>.</p>  
<p>In a model with two-stage sampling, population totals may be available
  for the PSUs actually sampled, but not for the whole population.  In
  this situation, calibrating within each PSU reduces with second-stage
  contribution to variance. This generalizes to multistage sampling.
  The <code>stage</code> argument specifies which stage of sampling the totals
  refer to.  Stage 0 is full population totals, stage 1 is totals for
  PSUs, and so on.  The default, <code>stage=NULL</code> is interpreted as
  stage 0 when a single population vector is supplied and stage 1 when a
  list is supplied. Calibrating to PSU totals will fail (with a message
  about an exactly singular matrix) for PSUs that have fewer
  observations than the number of calibration variables.</p>  
<p>The variance in the calibration model may depend on covariates.  If <code>variance=NULL</code> the
  calibration model has constant variance.  If <code>variance</code> is not <code>NULL</code>
  it specifies a linear combination of the columns of the model matrix
  and the calibration variance is proportional to that linear combination.
  Alternatively <code>variance</code> can be specified as a vector of values the
  same length as the input data specifying a heteroskedasticity parameter
  for each unit.</p>
<p>The design matrix specified by formula (after any aggregation) must be
  of full rank, with one exception. If the population total for a column
  is zero and all the observations are zero the column will be
  ignored. This allows the use of factors where the population happens
  to have no observations at some level.</p>
<p>In a two-phase design, <code>population</code> may be omitted when
  <code>phase=2</code>, to specify calibration to the phase-one sample. If the
  two-phase design object was constructed using the more memory-efficient
  <code>method="approx"</code> argument to <code><a href="twophase.html">twophase</a></code>, calibration of the first
  phase of sampling to the population is not supported.</p>


    </div>
    <div id="value">
    <h2>Value</h2>
    

<p>A survey design object.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Breslow NE, Lumley T, Ballantyne CM, Chambless LE, Kulich M. Using the
whole cohort in the analysis of case-cohort data. Am J Epidemiol.
2009;169(11):1398-1405. doi:10.1093/aje/kwp055</p>
<p>Deville J-C, Sarndal C-E, Sautory O (1993) Generalized Raking
Procedures in Survey Sampling. JASA 88:1013-1020</p>
<p>Kalton G, Flores-Cervantes I (2003) "Weighting methods" J Official
 Stat 19(2) 81-97</p>  
<p>Lumley T, Shaw PA, Dai JY (2011) "Connections between survey calibration estimators and semiparametric models for incomplete data" International Statistical Review. 79:200-220. (with discussion 79:221-232)</p>
<p>Sarndal C-E, Swensson B, Wretman J. "Model Assisted Survey
Sampling". Springer. 1991.</p>
<p>Rao JNK, Yung W, Hidiroglou MA (2002)   Estimating equations for the
analysis of survey data using poststratification information. Sankhya
64 Series A Part 2, 364-378.</p>
<p>Robins JM, Rotnitzky A, Zhao LP. (1994) Estimation of regression
coefficients when some regressors are not always observed. Journal of
the American Statistical Association, 89, 846-866.</p>
<p>Vanderhoeft C (2001) Generalized Calibration at Statistics
Belgium. Statistics Belgium Working Paper No 3.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="postStratify.html">postStratify</a></code>, <code><a href="rake.html">rake</a></code> for other ways
  to use auxiliary information</p>  
<p><code><a href="twophase.html">twophase</a></code> and <code><a href="https://cran.rstudio.com/web/packages/survey/vignettes/epi.pdf" class="external-link">vignette("epi")</a></code> for an example of calibration in two-phase designs</p>
<p><code>survey/tests/kalton.R</code> for examples replicating those in Kalton &amp; Flores-Cervantes (2003)</p>
<p><code><a href="make.calfun.html">make.calfun</a></code> for user-defined calibration distances.</p>
<p><code><a href="trimWeights.html">trimWeights</a></code> to trim final weights rather than calibration adjustments.</p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">api</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dclus1</span><span class="op">&lt;-</span><span class="fu"><a href="svydesign.html">svydesign</a></span><span class="op">(</span>id<span class="op">=</span><span class="op">~</span><span class="va">dnum</span>, weights<span class="op">=</span><span class="op">~</span><span class="va">pw</span>, data<span class="op">=</span><span class="va">apiclus1</span>, fpc<span class="op">=</span><span class="op">~</span><span class="va">fpc</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">cal_names</span><span class="op">(</span><span class="op">~</span><span class="va">stype</span>, <span class="va">dclus1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "(Intercept)" "stypeH"      "stypeM"     </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">pop.totals</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`(Intercept)`<span class="op">=</span><span class="fl">6194</span>, stypeH<span class="op">=</span><span class="fl">755</span>, stypeM<span class="op">=</span><span class="fl">1018</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## For a single factor variable this is equivalent to</span></span></span>
<span class="r-in"><span><span class="co">## postStratify</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">dclus1g</span><span class="op">&lt;-</span><span class="fu">calibrate</span><span class="op">(</span><span class="va">dclus1</span>, <span class="op">~</span><span class="va">stype</span>, <span class="va">pop.totals</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 - level Cluster Sampling design</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> With (15) clusters.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> calibrate(dclus1, ~stype, pop.totals)</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span>, <span class="va">dclus1g</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         mean    SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00 642.31 23.92</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">enroll</span>, <span class="va">dclus1g</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 3680893 406293</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span>, <span class="va">dclus1g</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        total SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE  4421  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH   755  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM  1018  0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Make weights constant within school district</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">dclus1agg</span><span class="op">&lt;-</span><span class="fu">calibrate</span><span class="op">(</span><span class="va">dclus1</span>, <span class="op">~</span><span class="va">stype</span>, <span class="va">pop.totals</span>, aggregate<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 - level Cluster Sampling design</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> With (15) clusters.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> calibrate(dclus1, ~stype, pop.totals, aggregate = 1)</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span>, <span class="va">dclus1agg</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         mean    SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00 640.31 25.71</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">enroll</span>, <span class="va">dclus1agg</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 3313035 268167</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span>, <span class="va">dclus1agg</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        total SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE  4421  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH   755  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM  1018  0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Now add sch.wide</span></span></span>
<span class="r-in"><span><span class="fu">cal_names</span><span class="op">(</span><span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">sch.wide</span>, <span class="va">dclus1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "(Intercept)" "stypeH"      "stypeM"      "sch.wideYes"</span>
<span class="r-in"><span><span class="op">(</span><span class="va">dclus1g2</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">dclus1</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">sch.wide</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop.totals</span>, sch.wideYes<span class="op">=</span><span class="fl">5122</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 - level Cluster Sampling design</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> With (15) clusters.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> calibrate(dclus1, ~stype + sch.wide, c(pop.totals, sch.wideYes = 5122))</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span>, <span class="va">dclus1g2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       mean    SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00  641 23.83</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">enroll</span>, <span class="va">dclus1g2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 3654414 403074</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span>, <span class="va">dclus1g2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        total SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE  4421  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH   755  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM  1018  0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Finally, calibrate on 1999 API and school type</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">cal_names</span><span class="op">(</span><span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">api99</span>, <span class="va">dclus1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "(Intercept)" "stypeH"      "stypeM"      "api99"      </span>
<span class="r-in"><span><span class="op">(</span><span class="va">dclus1g3</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">dclus1</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">api99</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop.totals</span>, api99<span class="op">=</span><span class="fl">3914069</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 - level Cluster Sampling design</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> With (15) clusters.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> calibrate(dclus1, ~stype + api99, c(pop.totals, api99 = 3914069))</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span>, <span class="va">dclus1g3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         mean     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00 665.31 3.4418</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">enroll</span>, <span class="va">dclus1g3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 3638487 385524</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span>, <span class="va">dclus1g3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        total SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE  4421  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH   755  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM  1018  0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Same syntax with replicate weights</span></span></span>
<span class="r-in"><span><span class="va">rclus1</span><span class="op">&lt;-</span><span class="fu"><a href="as.svrepdesign.html">as.svrepdesign</a></span><span class="op">(</span><span class="va">dclus1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">rclus1g3</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">rclus1</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">api99</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop.totals</span>, api99<span class="op">=</span><span class="fl">3914069</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call: calibrate(rclus1, ~stype + api99, c(pop.totals, api99 = 3914069))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Unstratified cluster jacknife (JK1) with 15 replicates.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span>, <span class="va">rclus1g3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         mean     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00 665.31 3.9429</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">enroll</span>, <span class="va">rclus1g3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 3638487 478749</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span>, <span class="va">rclus1g3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        total SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE  4421  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH   755  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM  1018  0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">rclus1agg3</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">rclus1</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">api99</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop.totals</span>,api99<span class="op">=</span><span class="fl">3914069</span><span class="op">)</span>, aggregate.index<span class="op">=</span><span class="op">~</span><span class="va">dnum</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call: calibrate(rclus1, ~stype + api99, c(pop.totals, api99 = 3914069), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     aggregate.index = ~dnum)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Unstratified cluster jacknife (JK1) with 15 replicates.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span>, <span class="va">rclus1agg3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         mean     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00 666.83 6.5308</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">enroll</span>, <span class="va">rclus1agg3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 3238699 438251</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span>, <span class="va">rclus1agg3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        total SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE  4421  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH   755  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM  1018  0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">###</span></span></span>
<span class="r-in"><span><span class="co">## Bounded weights</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1g3</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.4185925 1.8332949</span>
<span class="r-in"><span><span class="va">dclus1g3b</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">dclus1</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">api99</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop.totals</span>, api99<span class="op">=</span><span class="fl">3914069</span><span class="op">)</span>,bounds<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>,<span class="fl">1.6</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1g3b</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.6 1.6</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span>, <span class="va">dclus1g3b</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         mean     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00 665.48 3.4184</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">enroll</span>, <span class="va">dclus1g3b</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 3662213 378691</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span>, <span class="va">dclus1g3b</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        total SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE  4421  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH   755  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM  1018  0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Individual boundary constraints as constant values</span></span></span>
<span class="r-in"><span><span class="co"># the first weight will be bounded at 40, the rest free to move</span></span></span>
<span class="r-in"><span><span class="va">bnds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">apiclus1</span><span class="op">)</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>  upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">Inf</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">apiclus1</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1g3</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        1        2        3        4        5        6 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 51.63274 27.03836 25.26785 34.86947 34.25660 35.14186 </span>
<span class="r-in"><span><span class="va">dclus1g3b1</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">dclus1</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">api99</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop.totals</span>, api99<span class="op">=</span><span class="fl">3914069</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>  bounds<span class="op">=</span><span class="va">bnds</span>, bounds.const<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1g3b1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        1        2        3        4        5        6 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 40.00000 27.04817 25.28241 34.85830 34.24707 35.12996 </span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">api.stu</span>, <span class="va">dclus1g3b1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           total     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api.stu 3083274 329433</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## trimming</span></span></span>
<span class="r-in"><span><span class="va">dclus1tr</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">dclus1</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">api99</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop.totals</span>, api99<span class="op">=</span><span class="fl">3914069</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>   bounds<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">2</span><span class="op">)</span>, trim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">/</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 37 weights were trimmed</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span><span class="op">+</span><span class="va">api99</span><span class="op">+</span><span class="va">enroll</span>, <span class="va">dclus1tr</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          mean      SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00  662.73  3.4388</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api99  628.63  0.0000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 583.20 57.5477</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span>,<span class="va">dclus1tr</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE 4496.71  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH  684.89  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM 1012.40  0</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1tr</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.6666667 1.5000000</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">rclus1tr</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">rclus1</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">api99</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop.totals</span>, api99<span class="op">=</span><span class="fl">3914069</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>   bounds<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">2</span><span class="op">)</span>, trim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">/</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 37 weights were trimmed</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Failed to converge: eps=0.0392952671757451 in 51 iterations</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span><span class="op">+</span><span class="va">api99</span><span class="op">+</span><span class="va">enroll</span>, <span class="va">rclus1tr</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          mean      SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00  662.73  7.2853</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api99  628.63  5.5528</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enroll 583.20 63.0674</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span>,<span class="va">rclus1tr</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          total      SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE 4496.71 165.351</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH  684.89 168.518</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM 1012.40  56.543</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Input in the same format as rake() for classical raking</span></span></span>
<span class="r-in"><span><span class="va">pop.table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/xtabs.html" class="external-link">xtabs</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">sch.wide</span>,<span class="va">apipop</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">pop.table2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/xtabs.html" class="external-link">xtabs</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">comp.imp</span>,<span class="va">apipop</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dclus1r</span><span class="op">&lt;-</span><span class="fu"><a href="rake.html">rake</a></span><span class="op">(</span><span class="va">dclus1</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">sch.wide</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">comp.imp</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>               <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">pop.table</span>, <span class="va">pop.table2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">gclus1r</span><span class="op">&lt;-</span><span class="fu">calibrate</span><span class="op">(</span><span class="va">dclus1</span>, formula<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">sch.wide</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">comp.imp</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>     population<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">pop.table</span>, <span class="va">pop.table2</span><span class="op">)</span>,calfun<span class="op">=</span><span class="st">"raking"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span><span class="op">+</span><span class="va">stype</span>, <span class="va">dclus1r</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             mean     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00  642.87442 22.249</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE   0.71376  0.000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH   0.12189  0.000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM   0.16435  0.000</span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="va">api00</span><span class="op">+</span><span class="va">stype</span>, <span class="va">gclus1r</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             mean     SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api00  642.86932 22.244</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeE   0.71376  0.000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeH   0.12189  0.000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stypeM   0.16435  0.000</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## generalised raking</span></span></span>
<span class="r-in"><span><span class="va">dclus1g3c</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">dclus1</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">api99</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop.totals</span>,</span></span>
<span class="r-in"><span>    api99<span class="op">=</span><span class="fl">3914069</span><span class="op">)</span>, calfun<span class="op">=</span><span class="st">"raking"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1g3c</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.5342314 1.9947612</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">dclus1g3d</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">dclus1</span>, <span class="op">~</span><span class="va">stype</span><span class="op">+</span><span class="va">api99</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pop.totals</span>,</span></span>
<span class="r-in"><span>    api99<span class="op">=</span><span class="fl">3914069</span><span class="op">)</span>, calfun<span class="op">=</span><span class="va">cal.logit</span>, bounds<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">2.5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 - level Cluster Sampling design</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> With (15) clusters.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> calibrate(dclus1, ~stype + api99, c(pop.totals, api99 = 3914069), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     calfun = cal.logit, bounds = c(0.5, 2.5))</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1g3d</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">dclus1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.5943692 1.9358791</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Ratio estimators are calibration estimators</span></span></span>
<span class="r-in"><span><span class="va">dstrat</span><span class="op">&lt;-</span><span class="fu"><a href="svydesign.html">svydesign</a></span><span class="op">(</span>id<span class="op">=</span><span class="op">~</span><span class="fl">1</span>,strata<span class="op">=</span><span class="op">~</span><span class="va">stype</span>, weights<span class="op">=</span><span class="op">~</span><span class="va">pw</span>, data<span class="op">=</span><span class="va">apistrat</span>, fpc<span class="op">=</span><span class="op">~</span><span class="va">fpc</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">api.stu</span>,<span class="va">dstrat</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           total    SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api.stu 3086009 99477</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">common</span><span class="op">&lt;-</span><span class="fu"><a href="svyratio.html">svyratio</a></span><span class="op">(</span><span class="op">~</span><span class="va">api.stu</span>, <span class="op">~</span><span class="va">enroll</span>, <span class="va">dstrat</span>, separate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">common</span>, total<span class="op">=</span><span class="fl">3811472</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $total</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          enroll</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api.stu 3190038</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $se</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           enroll</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api.stu 29565.98</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">pop</span><span class="op">&lt;-</span><span class="fl">3811472</span></span></span>
<span class="r-in"><span><span class="co">## equivalent to (common) ratio estimator</span></span></span>
<span class="r-in"><span><span class="va">dstratg1</span><span class="op">&lt;-</span><span class="fu">calibrate</span><span class="op">(</span><span class="va">dstrat</span>,<span class="op">~</span><span class="va">enroll</span><span class="op">-</span><span class="fl">1</span>, <span class="va">pop</span>, variance<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">api.stu</span>, <span class="va">dstratg1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           total    SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api.stu 3190038 29566</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Alternatively specifying the heteroskedasticity parameters directly</span></span></span>
<span class="r-in"><span><span class="va">dstratgh</span> <span class="op">&lt;-</span> <span class="fu">calibrate</span><span class="op">(</span><span class="va">dstrat</span>,<span class="op">~</span><span class="va">enroll</span><span class="op">-</span><span class="fl">1</span>, <span class="va">pop</span>, variance<span class="op">=</span><span class="va">apistrat</span><span class="op">$</span><span class="va">enroll</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="surveysummary.html">svytotal</a></span><span class="op">(</span><span class="op">~</span><span class="va">api.stu</span>, <span class="va">dstratgh</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           total    SE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> api.stu 3190038 29566</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by “Thomas Lumley”.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

